<html>
<head>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/foundation/5.1.1/css/foundation.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <dl class="tabs" data-tab>
            <dd class="active"><a href="#container1">All</a></dd>
            <dd><a href="#container2">Last 30 days</a></dd>
            <dd><a href="#container3">Last 7 days</a></dd>
            <!-- <dd><a href="#container4">WTF graph</a></dd> -->

    </dl>
    <div class="tabs-content">
        <div class="content active" id="container1" style="height: 90%; width: 100%"></div>
        <div class="content" id="container2" style="height: 90%; width: 100%"></div>
        <div class="content" id="container3" style="height: 90%; width: 100%"></div>
        <!-- <div class="content" id="container4" style="height: 90%; width: 100%"></div> -->

    </div>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/foundation/5.1.1/js/foundation.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highcharts/3.0.9/highcharts.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/superagent/0.15.7/superagent.min.js"></script>
    <script>
    $(function () {
        $(document).foundation();
        var xAxis = {
                type: 'datetime'
            };

        var yAxis = {
                minPadding: 0,
                maxPadding: 0,
                allowDecimals: false,
                alternateGridColor: '#F4F4F4',
                title: {
                    text: 'Total customers'
                }
            };

        superagent.get('/api/customers').end(function (error, res) {
            if (error || res.status !== 200) {
                console.error('Status: ' + res.status, error);
                $('#container1').text('Status: ' + res.status + ' Message: ' + error);
                return;
            }

            var lineColour =  '#9E9E9E';
            var data = _.map(res.body, function (point) {
                var colour;
                if (point.delta < 0) {
                    colour = '#D86353';
                } else {
                    colour = '#89bf0a';
                }
                return {
                    x: point.x,
                    y: point.y,
                    color: colour,
                    delta: point.delta,
                    created: point.created
                }
            });

            $('#container1').highcharts({
                chart: {
                    type: 'line'
                },
                plotOptions: {
                    line: {
                        color: lineColour
                    },
                },
                title: {
                    text: 'Customers over time'
                },
                yAxis: yAxis,
                xAxis: xAxis,
                series: [{
                    name: 'Customers',
                    data: data
                }]
            });

            var monthAgo = Date.now() - 2592000000;
            $('#container2').highcharts({
                chart: {
                    type: 'line'
                },
                plotOptions: {
                    line: {
                        color: lineColour
                    },
                },
                title: {
                    text: 'Customers in the last 30 days'
                },
                yAxis: yAxis,
                xAxis: xAxis,
                series: [{
                    name: 'Customers',
                    data:  _.filter(data, function (point) {
                            return point.x >= monthAgo;
                    })
                }]
            });

            var weekAgo = Date.now() - 604800000;
            $('#container3').highcharts({
                chart: {
                    type: 'line'
                },
                plotOptions: {
                    line: {
                        color: lineColour
                      },
                },
                title: {
                    text: 'Customers in the last 7 days'
                },
                yAxis: yAxis,
                xAxis: xAxis,
                series: [{
                    name: 'Customers',
                    data: _.filter(data, function (point) {
                            return point.x >= weekAgo;
                    })
                }]
            });
        });
    });

    </script>
</body>
</html>
